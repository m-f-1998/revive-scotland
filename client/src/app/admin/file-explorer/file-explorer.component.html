<app-admin-navbar />
<div class="min-vh-100 p-3 p-md-5" style="font-family: 'Inter', sans-serif;">
  <div class="container-xxl">
    <div class="mb-4 p-4 shadow-sm rounded-3file-expl d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center border-bottom border-primary border-3">
      <h1 class="h3 fw-bold mb-3 mb-sm-0">
        <fa-icon [icon]="iconSvc.getIcon('fas', 'folder')" />
        File Explorer
      </h1>

      @if (!loading()) {
        @if (quota().max > 0) {
          <div class="d-flex flex-column align-items-start align-items-sm-end">
            <p class="text-sm font-monospace text-muted mb-1">
              Storage Used: <span class="fw-semibold">{{ fileExplorerSvc.formatBytes(quota().used) }}</span> / {{ fileExplorerSvc.formatBytes(quota().max) }}
            </p>
            <div class="progress d-none d-sm-block" style="width: 100%; min-width: 250px; height: 8px;">
              <div
                class="progress-bar bg-primary"
                role="progressbar"
                [style.width]="(quota().used / quota().max * 100) + '%'"
                [attr.aria-valuenow]="quota().used"
                aria-valuemin="0"
                [attr.aria-valuemax]="quota().max"
              ></div>
            </div>
          </div>
        }
      }
    </div>

    <div class="mb-3 d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb p-2 rounded-3 shadow-sm m-0">
          @for (crumb of breadcrumbs(); track crumb.path) {
            <li class="breadcrumb-item" aria-current="page">
              @if (crumb.path !== currentPath()) {
                <a (click)="listPath(crumb.path)" class="text-decoration-none text-primary fw-bold cursor-pointer">
                  {{ crumb.label }}
                </a>
              } @else {
                <span class="fw-bold text-secondary">
                  {{ crumb.label }}
                </span>
              }
            </li>
          }
        </ol>
      </nav>

      <div class="d-flex flex-wrap gap-2 justify-content-end">
        <input type="file" #fileInput (change)="onFileSelected($event);" multiple class="d-none">

        <div ngbDropdown>
          <button type="button" class="btn btn-primary btn-sm shadow-sm transition-transform" ngbDropdownToggle [disabled]="loading()">
            <fa-icon [icon]="iconSvc.getIcon('fas', 'cloud-upload-alt')" class="me-1" />
            Upload
          </button>
          <div ngbDropdownMenu>
            <button ngbDropdownItem (click)="fileInput.webkitdirectory=false; fileInput.click()">
              <fa-icon [icon]="iconSvc.getIcon('fas', 'file-upload')" class="me-2" />
              File
            </button>
            <button ngbDropdownItem (click)="fileInput.webkitdirectory=true; fileInput.click()">
              <fa-icon [icon]="iconSvc.getIcon('fas', 'folder')" class="me-2" />
              Folder
            </button>
          </div>
        </div>

        <button
          (click)="openModal('createFolder')"
          [disabled]="loading()"
          class="btn btn-success btn-sm shadow-sm transition-transform">
          <fa-icon [icon]="iconSvc.getIcon('fas', 'folder-plus')" class="me-1" />
          New Folder
        </button>
        <button
          (click)="listPath(currentPath())"
          [disabled]="loading()"
          class="btn btn-info btn-sm shadow-sm transition-transform"
          title="Refresh List">
          <fa-icon [icon]="iconSvc.getIcon('fas', 'refresh')" [animation]="loading() ? 'spin' : undefined" />
          Refresh
        </button>
      </div>
    </div>

    <div class="card shadow-lg rounded-3">
      @if (loading()) {
        <div class="card-body p-5 text-center text-muted">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading files and folders...</p>
        </div>
      } @else {
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead>
              <tr>
                <th scope="col" class="py-3">Name</th>
                <th scope="col" class="d-none d-sm-table-cell py-3">Size</th>
                <th scope="col" class="d-none d-md-table-cell py-3">Last Modified</th>
                <th scope="col" class="py-3 text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              @if (currentPath() !== '') {
                <tr class="cursor-pointer" (dragover)="onDragOver($event)" (drop)="upAFolder($event)">
                  <td class="text-primary fw-semibold">
                    <a (click)="goUp()" class="text-decoration-none text-primary fw-semibold d-flex align-items-center cursor-pointer">
                      <fa-icon [icon]="iconSvc.getIcon('fas', 'arrow-up')" class="me-2" />
                      ...
                    </a>
                  </td>
                  <td class="d-none d-sm-table-cell text-muted">--</td>
                  <td class="d-none d-md-table-cell text-muted">--</td>
                  <td></td>
                </tr>
              }

              @for (file of fileList(); track file.key) {
                <tr class="cursor-pointer" [draggable]="!file.isFolder" (dragstart)="!file.isFolder ? onDragStart($event, file) : null" (dragover)="file.isFolder ? onDragOver($event) : null" (drop)="file.isFolder ? onDrop($event, file): null">
                  <td>
                    <a (click)="file.isFolder ? navigateTo(file.name) : viewFile(file.key)" class="d-flex align-items-center text-decoration-none">
                      @if (file.isFolder) {
                        <fa-icon [icon]="iconSvc.getIcon('fas', 'folder')" class="me-2 text-warning" />
                      } @else {
                        <fa-icon [icon]="iconSvc.getIcon('fas', 'file-alt')" class="me-2 text-info" />
                      }
                      <span [class]="{ 'fw-bold text-primary': file.isFolder }">
                        {{ file.name }}
                      </span>
                    </a>
                  </td>
                  <td class="d-none d-sm-table-cell text-muted">
                    {{ file.isFolder ? '--' : fileExplorerSvc.formatBytes(file.size ?? 0) }}
                  </td>
                  <td class="d-none d-md-table-cell text-muted">
                    {{ file.lastModified | date:'medium' }}
                  </td>
                  <td class="text-end">
                    <div class="btn-group" role="group">
                      <button (click)="openModal('rename', file)" title="Rename/Move" class="btn btn-outline-secondary btn-sm p-1 rounded-circle border-0">
                        <fa-icon [icon]="iconSvc.getIcon('fas', 'pen-to-square')" />
                      </button>
                      <button (click)="openModal('delete', file)" title="Delete" class="btn btn-outline-danger btn-sm p-1 rounded-circle border-0">
                        <fa-icon [icon]="iconSvc.getIcon('fas', 'trash')" />
                      </button>
                      @if (!file.isFolder) {
                        <button (click)="shareFile(file.key)" title="Share Link" class="btn btn-outline-info btn-sm p-1 rounded-circle border-0">
                          <fa-icon [icon]="iconSvc.getIcon('fas', 'share')" />
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              } @empty {
                <tr>
                  <td colspan="4" class="p-5 text-center text-secondary fs-6">
                    <fa-icon [icon]="iconSvc.getIcon('fas', 'triangle-exclamation')" class="me-2" /> This folder is empty.
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>
  </div>
</div>