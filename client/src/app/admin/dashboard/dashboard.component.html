<app-admin-navbar />
@if (authSvc.loading() || loading() ) {
  <div class="d-flex flex-column align-items-center m-3">
    <fa-icon [icon]="iconSvc.getIcon('fas', 'spinner')" class="fa-spin fa-3x" />
    <div class="mt-2">Loading dashboard...</div>
  </div>
} @else {
  <div class="container-fluid p-4">
    <header class="p-4 pt-0 mb-4 border-bottom shadow-sm rounded">
      <div class="d-flex align-items-center">
        <div class="flex-shrink-0 me-4">
          <img
            [src]="authSvc.currentUser()?.photoURL"
            class="rounded-circle border border-primary border-3"
            alt="User Avatar"
            style="width: 64px; height: 64px; object-fit: cover;"
            onerror="this.onerror=null; this.src='default-avatar.png';"
          >
        </div>

        <div class="flex-grow-1">
          <h1 class="display-6 mb-1 fw-bold">
            Welcome{{ authSvc.currentUser()?.displayName ? ', ' + authSvc.currentUser()?.displayName : '' }}! ðŸ‘‹
          </h1>
          <p class="lead text-muted mb-0">
            Your analytics overview for the last 90 days is ready. Data is refreshed daily.
          </p>
          @if (authSvc.currentUser()?.email) {
            <small class="text-secondary">
              Authenticated as: {{ authSvc.currentUser()?.email }}
            </small>
          }
        </div>
      </div>
    </header>
    <div class="row g-4 mb-4">
      <div class="col-12 col-lg-8">
        <div class="card shadow h-100">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Daily Traffic Trends</h5>
          </div>
          <div class="card-body" style="height: 400px;">
            <canvas baseChart
              [type]="'line'"
              [datasets]="trendChartData.datasets"
              [labels]="trendChartData.labels"
              [options]="trendChartOptions"
              [legend]="true">
            </canvas>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card shadow h-100">
          <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Sessions by Device Category</h5>
          </div>
          <div class="card-body d-flex justify-content-center align-items-center" style="height: 400px;">
            <canvas baseChart
              [type]="'doughnut'"
              [datasets]="deviceChartData.datasets"
              [labels]="deviceChartData.labels"
              [options]="deviceChartOptions"
              [legend]="true">
            </canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-12 col-lg-6">
        <div class="card shadow h-100">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0">Top 10 Locations by Active Users</h5>
          </div>
          <div class="card-body p-0">
            <table class="table table-striped table-hover table-borderless mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">Country</th>
                  <th scope="col">City</th>
                  <th scope="col" class="text-end">Users</th>
                  <th scope="col" class="text-end">Sessions</th>
                </tr>
              </thead>
              <tbody>
                @for (geo of dashboardData!.geographyData; track geo.country + geo.city) {
                  <tr>
                    <td>
                      <strong>{{ geo.country }}</strong>
                    </td>
                    <td>{{ geo.city }}</td>
                    <td class="text-end">{{ geo.activeUsers | number }}</td>
                    <td class="text-end">{{ geo.sessions | number }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          @if (dashboardData!.geographyData.length === 0) {
            <div class="card-footer text-center text-muted">
                No location data found for this period.
            </div>
          }
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card shadow h-100">
          <div class="card-header bg-secondary text-white">
              <h5 class="mb-0">Sessions by Channel Group</h5>
          </div>
          <div class="card-body p-0">
            <table class="table table-striped table-hover table-borderless mb-0">
              <thead class="table-light">
                <tr>
                    <th scope="col">Channel Group</th>
                    <th scope="col" class="text-end">Sessions</th>
                    <th scope="col" class="text-end">Percentage</th>
                </tr>
              </thead>
              <tbody>
                @for (source of dashboardData!.trafficSourceData; track source.channel) {
                  <tr>
                    <td>
                      <span class="fw-bold">
                        {{ source.channel }}
                      </span>
                    </td>
                    <td class="text-end">
                      {{ source.sessions | number }}
                    </td>
                    <td class="text-end">
                      <span>
                        @if (dashboardData?.overview?.sessions) {
                          {{(source.sessions / dashboardData!.overview!.sessions) * 100 | number:'1.1-1'}}
                        } @else {
                          0.0
                        }%
                      </span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          @if (dashboardData!.trafficSourceData.length === 0) {
            <div class="card-footer text-center text-muted">
              No traffic source data found for this period.
            </div>
          }
        </div>
      </div>
    </div>
  </div>
}